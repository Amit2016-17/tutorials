<!DOCTYPE html>

<html>
  <head>
    <meta
      name="viewport"
      content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes"
    />
    <meta name="theme-color" content="#4F7DC9" />
    <meta charset="UTF-8" />
    <title>Build a data source plugin</title>
    <link
      rel="stylesheet"
      href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono"
    />
    <link
      rel="stylesheet"
      href="//fonts.googleapis.com/icon?family=Material+Icons"
    />
    <link
      rel="stylesheet"
      href="https://storage.googleapis.com/grafana-tutorials-staging/codelab-elements/codelab-elements.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://storage.googleapis.com/grafana-tutorials-staging/google-codelab.css"
    />
    <style>
      .success {
        color: #1e8e3e;
      }
      .error {
        color: red;
      }
    </style>
  </head>
  <body>
    <google-codelab-analytics gaid="UA-49880327-14"></google-codelab-analytics>
    <google-codelab
      codelab-gaid=""
      id="build-a-data-source-plugin"
      title="Build a data source plugin"
      environment="web"
      feedback-link="https://github.com/grafana/tutorials/issues/new"
    >
      
      <google-codelab-step label="Introduction" duration="1">
        <p>Grafana supports a wide range of data sources, including Prometheus, MySQL, and even Datadog. There&#39;s a good chance you can already visualize metrics from the systems you have set up. In some cases, though, you already have an in-house metrics solution that you&#39;d like to add to your Grafana dashboards. This tutorial teaches you to build a support for your data source.</p>
<h2 class="checklist" is-upgraded>What you&#39;ll learn</h2>
<ul class="checklist">
<li>How to build a data source</li>
<li>How to construct queries using the query editor</li>
<li>How to configure your data source using the config editor</li>
</ul>
<h2 is-upgraded>What you&#39;ll need</h2>
<ul>
<li>Grafana version 7.0+</li>
<li>NodeJS</li>
<li>yarn</li>
</ul>


      </google-codelab-step>
      
      <google-codelab-step label="Set up your environment" duration="1">
        <p>Before you can get started building plugins, you need to set up your environment for plugin development.</p>
<p>To discover plugins, Grafana scans a <em>plugin directory</em>, the location of which depends on your operating system.</p>
<p>1. Create a directory called <code>grafana-plugins</code> in your preferred workspace.</p>
<p>2. Find the <code>plugins</code> property in the Grafana configuration file and set the <code>plugins</code> property to the path of your <code>grafana-plugins</code> directory. Refer to the <a href="https://grafana.com/docs/grafana/latest/installation/configuration/#plugins" target="_blank">Grafana configuration documentation</a> for more information.</p>
<pre><code>[paths]
plugins = &#34;/path/to/grafana-plugins&#34;
</code></pre>
<p>Restart Grafana if it&#39;s already running, to load the new configuration.</p>
<h2 is-upgraded>Alternative method: Docker</h2>
<p>If you don&#39;t want to install Grafana on your local machine, you can use <a href="https://www.docker.com" target="_blank">Docker</a>. To set up Grafana for plugin development using Docker, run the following command:</p>
<pre><code>docker run -d -p 3000:3000 -v &#34;$(pwd)&#34;/grafana-plugins:/var/lib/grafana/plugins --name=grafana grafana/grafana
</code></pre>
<p>Since Grafana only loads plugins on start-up, you need to restart the container whenever you add or remove a plugin.</p>
<pre><code>docker restart grafana
</code></pre>



      </google-codelab-step>
      
      <google-codelab-step label="Create a new plugin" duration="1">
        <p>Tooling for modern web development can be tricky to wrap your head around. While you certainly can write you own webpack configuration, for this guide, you&#39;ll be using <em>grafana-toolkit</em>.</p>
<p><a href="https://github.com/grafana/grafana/tree/master/packages/grafana-toolkit" target="_blank">grafana-toolkit</a> is a CLI application that simplifies Grafana plugin development, so that you can focus on code. The toolkit takes care of building and testing for you.</p>
<p>1. In the plugin directory, create a panel plugin from template using the <code>plugin:create</code> command:</p>
<pre><code>npx grafana-toolkit plugin:create my-plugin
</code></pre>
<p>2. Change directory.</p>
<pre><code>cd my-plugin
</code></pre>
<p>3. Download necessary dependencies:</p>
<pre><code>yarn install
</code></pre>
<p>4. Build the plugin:</p>
<pre><code>yarn dev
</code></pre>
<p>5. Restart the Grafana server for Grafana to discover your plugin.</p>
<p>6. Open Grafana and go to <strong>Configuration</strong> -&gt; <strong>Plugins</strong>. Make sure that your plugin is there.</p>
<p>By default, Grafana logs whenever it discovers a plugin:</p>
<pre><code>INFO[01-01|12:00:00] Registering plugin       logger=plugins name=my-plugin
</code></pre>



      </google-codelab-step>
      
      <google-codelab-step label="Your first data source" duration="2">
        <p>A data source in Grafana must extend the <code>DataSourceApi</code> interface, which requires you to defines two methods: <code>query</code> and <code>testDatasource</code>.</p>
<h2 is-upgraded>Query data</h2>
<p>The <code>query</code> method accepts a query from the user, and returns the data in a format that Grafana recognizes. This is where most of the work happens.</p>
<pre><code>async query(options: DataQueryRequest&lt;MyQuery&gt;): Promise&lt;DataQueryResponse&gt;
</code></pre>
<p>The <code>DataQueryRequest</code> object contains the queries, or <em>targets</em>, that the user made, along with context information, like the current time interval. Use this information to query an external database.</p>
<p>After you receive the results from your database query, you need to return it as a _data frame_â€”the data format that Grafana uses internally.</p>
<aside class="special"><p>The term <em>target</em> originates from Graphite, and the earlier days of Grafana when Graphite was the only supported data source. As Grafana gained support for more data sources, the term &#34;target&#34; became synonymous with any type of query.</p>
</aside>
<h2 is-upgraded>Test your data source</h2>
<p><code>testDatasource</code> implements a health check for your data source. For example, Grafana calls this method whenever the user clicks the <strong>Save &amp; Test</strong> button, after changing the connection settings.</p>
<pre><code>async testDatasource()
</code></pre>


      </google-codelab-step>
      
      <google-codelab-step label="Support custom queries" duration="3">
        <p>Most data sources offer a way to query specific data. MySQL and PostgreSQL use SQL, while Prometheus has its own query language, called <em>PromQL</em>. No matter what query language your databases are using, Grafana lets you build support for it.</p>
<p>Add support for custom queries to your data source, by implementing a your own <em>query editor</em>, a React component that enables users to build their own queries, through a user-friendly graphical interface.</p>
<p>A query editor can be as simple a text field where the user edits the raw query text, or it can provide a more user-friendly form with drop-down menus and switches, that later gets converted into the raw query text before it gets sent off to the database.</p>
<p>The first step in designing your query editor is to define its <em>query model</em>. The query model defines the user input to your data source. The query model in the starter plugin you created, defines two values: the query text, and a constant.</p>
<p><strong>types.ts</strong></p>
<pre><code>export interface MyQuery extends DataQuery {
  queryText?: string;
  constant: number;
}
</code></pre>
<p>Now that you&#39;ve defined the query model you wish to support, the next step is to bind the model to a form. The <code>FormField</code> is a text field component from <code>grafana/ui</code> that lets you register a listener, which will be invoked whenever the form field value changes.</p>
<p><strong>QueryEditor.tsx</strong></p>
<pre><code>&lt;FormField value={queryText || &#39;&#39;} onChange={this.onQueryTextChange} label=&#34;Query Text&#34;&gt;&lt;/FormField&gt;
</code></pre>
<p>The registered listener, <code>onQueryTextChange</code>, calls <code>onChange</code> to update the current query:</p>
<pre><code>onQueryTextChange = (event: ChangeEvent&lt;HTMLInputElement&gt;) =&gt; {
    const { onChange, query } = this.props;
    onChange({ ...query, queryText: event.target.value });
  };
</code></pre>
<p>If you want the query to run automatically after updating the query, you can add a call to <code>onRunQuery</code>:</p>
<pre><code>onRunQuery();
</code></pre>


      </google-codelab-step>
      
      <google-codelab-step label="Configure your data source" duration="2">
        <p>To access a specific data source, you often need to configure things like hostname, credentials, or authentication method. A <em>config editor</em> lets you users configure your data source plugin to fit their needs.</p>
<p>The config editor looks similar to the query editor, in that it defines a model and binds it to a form.</p>
<p><strong>types.ts</strong></p>
<pre><code>export interface MyDataSourceOptions extends DataSourceJsonData {
  path?: string;
}
</code></pre>
<p>Just like query editor, the form field in the config editor calls the registered listener whenever the value changes.</p>
<p><strong>ConfigEditor.tsx</strong></p>
<pre><code>&lt;FormField
  label=&#34;Path&#34;
  onChange={this.onPathChange}
  value={jsonData.path || &#39;&#39;}
  placeholder=&#34;json field returned to frontend&#34;
/&gt;
</code></pre>
<p>To update the options for the data source, call the <code>onOptionsChange</code> method:</p>
<pre><code>onPathChange = (event: ChangeEvent&lt;HTMLInputElement&gt;) =&gt; {
    const { onOptionsChange, options } = this.props;
    const jsonData = {
      ...options.jsonData,
      path: event.target.value,
    };
    onOptionsChange({ ...options, jsonData });
  };
</code></pre>


      </google-codelab-step>
      
      <google-codelab-step label="Congratulations" duration="0">
        <p>Congratulations, you made it to the end of this tutorial!</p>


      </google-codelab-step>
      
    </google-codelab>

    <script src="https://storage.googleapis.com/grafana-tutorials-staging/codelab-elements/native-shim.js"></script>
    <script src="https://storage.googleapis.com/grafana-tutorials-staging/codelab-elements/custom-elements.min.js"></script>
    <script src="https://storage.googleapis.com/grafana-tutorials-staging/codelab-elements/prettify.js"></script>
    <script src="https://storage.googleapis.com/grafana-tutorials-staging/codelab-elements/codelab-elements.js"></script>
    <script src="//support.google.com/inapp/api.js"></script>
  </body>
</html>
